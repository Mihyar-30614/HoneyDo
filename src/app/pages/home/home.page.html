<ion-header>
	<ion-toolbar>
		<ion-buttons slot="start" *ngIf="viewState === 'todos'">
			<ion-button (click)="backToProjects()">
				<ion-icon color="primary" name="arrow-back"></ion-icon>
			</ion-button>
		</ion-buttons>
		<ion-title>{{ viewState === 'projects' ? 'Projects' : selectedProject?.name }}</ion-title>
		<ion-buttons slot="end">
			<ion-button shape="round" class="avatar-button" (click)="openUserMenu($event)">
				{{ userInitials }}
			</ion-button>
		</ion-buttons>
	</ion-toolbar>
</ion-header>

<ion-content>
	<!-- Projects View -->
	<div *ngIf="viewState === 'projects'">
		<ion-searchbar [(ngModel)]="projectSearch" placeholder="Search projects..." animated></ion-searchbar>

		<div class="add-project">
			<ion-input [(ngModel)]="newProjectName" placeholder="New project name..."
				(ionChange)="newProjectName = $event.detail.value || ''"></ion-input>
			<ion-textarea [(ngModel)]="newProjectDescription" placeholder="Project description (optional)"
				rows="2"></ion-textarea>
			<ion-button (click)="addProject()" [disabled]="!newProjectName.trim()">
				<ion-icon name="add"></ion-icon>
				Add Project
			</ion-button>
		</div>

		<h2 class="section-title">Active Projects</h2>
		<ion-grid>
			<ion-row>
				<ion-col size="12" size-md="6" *ngFor="let project of projects | projectFilter: projectSearch">
					<ion-card [class.selected]="selectedProject?.id === project.id" (click)="selectProject(project)">
						<ion-card-header>
							<ion-card-title>{{ project.name }}</ion-card-title>
							<ion-card-subtitle *ngIf="project.description">{{ project.description }}</ion-card-subtitle>
						</ion-card-header>
						<ion-card-content>
							<div class="project-stats">
								<p class="creation-date" *ngIf="project.createdAt">Created: {{ project.createdAt |
									date:'mediumDate' }}</p>
								<div class="progress-container">
									<ion-progress-bar [value]="project.progress || 0"></ion-progress-bar>
									<p class="progress-text">{{ (project.progress || 0) | percent }} Complete</p>
								</div>
							</div>
							<div class="ion-padding-top">
								<ion-button class="action-button edit-button"
									(click)="editProj(project); $event.stopPropagation()">
									<ion-icon name="create"></ion-icon>
									Edit
								</ion-button>
								<ion-button class="action-button archive-button"
									(click)="archiveProject(project.id); $event.stopPropagation()">
									<ion-icon name="archive"></ion-icon>
									Archive
								</ion-button>
							</div>
						</ion-card-content>
					</ion-card>
				</ion-col>
			</ion-row>
		</ion-grid>

		<h2 class="section-title">Archived Projects</h2>
		<div *ngIf="archivedProjects.length === 0" class="empty-state">
			<ion-icon name="archive-outline"></ion-icon>
			<h3>No Archived Projects</h3>
			<p>Archived projects will appear here</p>
		</div>
		<ion-grid>
			<ion-row>
				<ion-col size="12" size-md="6" *ngFor="let project of archivedProjects | projectFilter: projectSearch">
					<ion-card>
						<ion-card-header>
							<ion-card-title>{{ project.name }}</ion-card-title>
							<ion-card-subtitle *ngIf="project.description">{{ project.description }}</ion-card-subtitle>
						</ion-card-header>
						<ion-card-content>
							<ion-progress-bar [value]="project.progress"></ion-progress-bar>
							<div class="ion-padding-top">
								<ion-button class="action-button unarchive-button"
									(click)="unarchiveProject(project.id)">
									<ion-icon name="refresh"></ion-icon>
									Unarchive
								</ion-button>
							</div>
						</ion-card-content>
					</ion-card>
				</ion-col>
			</ion-row>
		</ion-grid>
	</div>

	<!-- Todos View -->
	<div *ngIf="viewState === 'todos' && selectedProject">
		<div class="add-todo">
			<ion-input [(ngModel)]="newTodoTitle" placeholder="New todo..."
				(ionChange)="newTodoTitle = $event.detail.value || ''"></ion-input>
			<ion-button (click)="addTodo()" [disabled]="!newTodoTitle.trim()">
				<ion-icon name="add"></ion-icon>
				Add Todo
			</ion-button>
		</div>

		<div class="todo-stats">
			<div class="stat-item total">
				<div class="stat-value">{{ todos.length }}</div>
				<div class="stat-label">Total</div>
			</div>
			<div class="stat-item new">
				<div class="stat-value">{{ newTodosCount }}</div>
				<div class="stat-label">New</div>
			</div>
			<div class="stat-item in-progress">
				<div class="stat-value">{{ inProgressTodosCount }}</div>
				<div class="stat-label">In Progress</div>
			</div>
			<div class="stat-item done">
				<div class="stat-value">{{ doneTodosCount }}</div>
				<div class="stat-label">Done</div>
			</div>
		</div>

		<h2 class="section-title">Active Todos</h2>
		<div *ngIf="todos.length === 0" class="empty-state">
			<ion-icon name="checkbox-outline"></ion-icon>
			<h3>No Active Todos</h3>
			<p>Add a new todo to get started</p>
		</div>
		<ion-list>
			<ion-item *ngFor="let todo of todos" class="todo-item" [class.done]="todo.status === 'done'">
				<ion-label>
					<h2 [class.line-through]="todo.status === 'done'">{{ todo.title }}</h2>
					<p>Created: {{ todo.createdAt?.toDate() | date:'short' }}</p>
				</ion-label>
				<ion-badge slot="end" class="status-badge" [class]="todo.status">
					{{ todo.status }}
				</ion-badge>
				<ion-button slot="end" fill="clear" (click)="cycleStatus(todo)">
					<ion-icon [name]="todo.status === 'done' ? 'checkmark-circle' : 'ellipse-outline'"></ion-icon>
				</ion-button>
				<ion-button slot="end" fill="clear" (click)="editT(todo)">
					<ion-icon name="create"></ion-icon>
				</ion-button>
				<ion-button slot="end" fill="clear" (click)="archiveTodo(todo.id)">
					<ion-icon name="archive"></ion-icon>
				</ion-button>
				<ion-button slot="end" fill="clear" (click)="deleteTodo(todo.id)">
					<ion-icon name="trash"></ion-icon>
				</ion-button>
			</ion-item>
		</ion-list>

		<h2 class="section-title">Archived Todos</h2>
		<div *ngIf="archivedTodos.length === 0" class="empty-state">
			<ion-icon name="archive-outline"></ion-icon>
			<h3>No Archived Todos</h3>
			<p>Archived todos will appear here</p>
		</div>
		<ion-list>
			<ion-item *ngFor="let todo of archivedTodos" class="todo-item">
				<ion-label>
					<h2>{{ todo.title }}</h2>
					<p>Created: {{ todo.createdAt?.toDate() | date:'short' }}</p>
				</ion-label>
				<ion-badge slot="end" class="status-badge" [class]="todo.status">
					{{ todo.status }}
				</ion-badge>
				<ion-button slot="end" fill="clear" (click)="unarchiveTodo(todo.id)">
					<ion-icon name="refresh"></ion-icon>
				</ion-button>
				<ion-button slot="end" fill="clear" (click)="deleteTodo(todo.id)">
					<ion-icon name="trash"></ion-icon>
				</ion-button>
			</ion-item>
		</ion-list>
	</div>

	<!-- User Dropdown Menu -->
	<div class="user-dropdown" *ngIf="userMenuOpen">
		<ion-list>
			<ion-item button (click)="editProfile()">
				<ion-icon name="person" slot="start"></ion-icon>
				<ion-label>Edit Profile</ion-label>
			</ion-item>
			<ion-item button (click)="logout()">
				<ion-icon name="log-out" slot="start"></ion-icon>
				<ion-label>Logout</ion-label>
			</ion-item>
		</ion-list>
	</div>

	<!-- Edit Project Modal -->
	<ion-modal [isOpen]="editingProject !== null" (didDismiss)="cancelProjectEdit()">
		<ng-template>
			<ion-header>
				<ion-toolbar>
					<ion-title>Edit Project</ion-title>
					<ion-buttons slot="end">
						<ion-button (click)="cancelProjectEdit()">Cancel</ion-button>
					</ion-buttons>
				</ion-toolbar>
			</ion-header>
			<ion-content class="ion-padding">
				<ion-item>
					<ion-input [(ngModel)]="editProjectName" placeholder="Project name"
						(ionChange)="editProjectName = $event.detail.value || ''"></ion-input>
				</ion-item>
				<ion-item>
					<ion-textarea [(ngModel)]="editProjectDescription" placeholder="Project description"
						rows="3"></ion-textarea>
				</ion-item>
				<ion-button expand="block" (click)="updateProject()" [disabled]="!editProjectName.trim()">
					Save Changes
				</ion-button>
			</ion-content>
		</ng-template>
	</ion-modal>

	<!-- Edit Todo Modal -->
	<ion-modal [isOpen]="editingTodo !== null" (didDismiss)="cancelTodoEdit()">
		<ng-template>
			<ion-header>
				<ion-toolbar>
					<ion-title>Edit Todo</ion-title>
					<ion-buttons slot="end">
						<ion-button (click)="cancelTodoEdit()">Cancel</ion-button>
					</ion-buttons>
				</ion-toolbar>
			</ion-header>
			<ion-content class="ion-padding">
				<ion-item>
					<ion-input [(ngModel)]="editTodoTitle" placeholder="Todo title"
						(ionChange)="editTodoTitle = $event.detail.value || ''"></ion-input>
				</ion-item>
				<ion-button expand="block" (click)="updateTodo()" [disabled]="!editTodoTitle.trim()">
					Save Changes
				</ion-button>
			</ion-content>
		</ng-template>
	</ion-modal>
</ion-content>